<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paxban - Monitoreo de Incendios</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root {
            --paxban-green: #1b5e20;
            --paxban-light-green: #f1f8e9;
            --paxban-accent: #2e7d32;
        }
        body, html { height: 100%; margin: 0; font-family: 'Inter', 'Segoe UI', sans-serif; overflow: hidden; background-color: #f8f9fa; }
        
        .header-dash {
            background: linear-gradient(90deg, var(--paxban-green) 0%, #2e7d32 100%);
            color: white;
            padding: 12px 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1030;
            position: relative;
        }

        .dashboard-wrapper { height: calc(100vh - 56px); }

        .sidebar {
            width: 250px;
            background: var(--paxban-light-green);
            border-right: 1px solid #c8e6c9;
            display: flex;
            flex-direction: column;
            padding: 20px;
            z-index: 1000;
        }

        .nav-section-title {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #666;
            margin-bottom: 15px;
            font-weight: 700;
        }

        .btn-nav {
            width: 100%;
            text-align: left;
            border: none;
            background: white;
            margin-bottom: 12px;
            padding: 12px 15px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 12px;
            color: #444;
            font-weight: 500;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .btn-nav:hover {
            background: #fff;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            color: var(--paxban-green);
        }

        .btn-nav.active {
            background: var(--paxban-green);
            color: white;
            box-shadow: 0 4px 15px rgba(27, 94, 32, 0.3);
        }

        #map, #iframe-container { flex-grow: 1; height: 100%; width: 100%; }
        #iframe-container iframe { width: 100%; height: 100%; border: none; }

        .legend {
            background: white;
            padding: 12px;
            line-height: 18px;
            color: #555;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            border: 1px solid #eee;
        }
        .legend i { width: 14px; height: 14px; float: left; margin-right: 8px; opacity: 0.8; border-radius: 50%; }

        /* Estilo para la etiqueta de distancia sobre la l√≠nea */
        .dist-label {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #000;
            font-weight: bold;
            color: #000;
            padding: 1px 5px;
            border-radius: 3px;
            font-size: 11px;
        }

        /* Estilo para la etiqueta de texto permanente en el centro del pol√≠gono */
        .label-style {
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid #2e7d32;
            color: #1b5e20;
            font-weight: bold;
            font-size: 12px;
            text-align: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }

        .filter-control {
            background: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            border: 1px solid #eee;
            margin-bottom: 10px;
            font-size: 13px;
            color: #555;
        }

        @media (max-width: 768px) {
            .dashboard-wrapper { flex-direction: column !important; }
            .sidebar { width: 100%; height: auto; border-right: none; border-bottom: 1px solid #dee2e6; padding: 15px; }
            body { overflow: auto; }
            #map, #iframe-container { height: 70vh; }
            .btn-nav { padding: 10px 15px; font-size: 0.9rem; }
        }
    </style>
</head>
<body>
    <div class="header-dash d-flex justify-content-between align-items-center">
        <h5 class="m-0 fw-bold"><span class="d-none d-sm-inline">üõ∞Ô∏è</span> Sistema de Alerta Temprana Paxban</h5>
        <div class="d-flex align-items-center gap-3">
            <span class="text-white small d-none d-md-block" id="last-updated-label" style="opacity: 0.9; font-size: 0.85rem;">Actualizando...</span>
            <span class="badge bg-white text-success px-3 py-2">‚óè Monitoreo Activo</span>
        </div>
    </div>

    <div class="dashboard-wrapper d-flex flex-md-row">
        <!-- Barra Lateral Izquierda -->
        <aside class="sidebar">
            <div class="nav-section-title">Navegaci√≥n Principal</div>
            <button class="btn-nav active" id="btn-map" onclick="showView('map')">
                <span>üìç</span> Mapa en Tiempo Real
            </button>
            <button class="btn-nav" id="btn-gallery" onclick="showView('gallery')">
                <span>üìÇ</span> Galer√≠a de Reportes
            </button>
        </aside>

        <!-- Contenido Principal -->
        <main class="flex-grow-1 position-relative bg-white">
            <div id="map"></div>
            <div id="iframe-container" class="d-none">
                <iframe src="reportes.html" id="gallery-frame"></iframe>
            </div>
        </main>
    </div>

    <script>
        function showView(view) {
            const mapDiv = document.getElementById('map');
            const galleryDiv = document.getElementById('iframe-container');
            const btnMap = document.getElementById('btn-map');
            const btnGallery = document.getElementById('btn-gallery');
            
            btnMap.classList.remove('active');
            btnGallery.classList.remove('active');
            
            if (view === 'map') {
                mapDiv.classList.remove('d-none');
                galleryDiv.classList.add('d-none');
                btnMap.classList.add('active');
                // Forzar re-render de Leaflet al volver al mapa
                setTimeout(() => { map.invalidateSize(); }, 100);
            } else {
                mapDiv.classList.add('d-none');
                galleryDiv.classList.remove('d-none');
                btnGallery.classList.add('active');
            }
        }
    </script>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
    <script>
        // --- 1. CONFIGURACI√ìN DE MAPAS ---
        // Usamos National Geographic como base principal
        const natgeo = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/NatGeo_World_Map/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri &mdash; National Geographic',
            maxZoom: 16
        });

        const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri'
        });

        const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap'
        });

        const baseMaps = {
            "National Geographic": natgeo,
            "Sat√©lite": satellite,
            "Mapa Callejero": osm
        };

        const map = L.map('map', {
            center: [17.2, -90.0], // Centro de Pet√©n
            zoom: 8,               // Vista general amplia de la regi√≥n
            layers: [natgeo]
        });

        L.control.layers(baseMaps).addTo(map);

        let paxbanFeature = null;
        let activeLine = null;
        var incendiosLayer = L.layerGroup().addTo(map);
        var allIncendios = [];

        // --- 2. CARGAR PAXBAN COMO "FILTRO DE COLOR" ---
        fetch('concesiones1.geojson?t=' + new Date().getTime())
            .then(response => response.json())
            .then(data => {
                // Buscamos el pol√≠gono de Paxb√°n para c√°lculos
                paxbanFeature = data.features.find(f => {
                    const name = f.properties.Name || "";
                    return name.toLowerCase().includes("paxb√°n") || name.toLowerCase().includes("paxban");
                });
                
                const paxbanLayer = L.geoJSON(data, {
                    filter: function(feature) {
                        const name = feature.properties.Name || "";
                        return name.toLowerCase().includes("paxb√°n") || name.toLowerCase().includes("paxban");
                    },
                    style: function(feature) {
                        return {
                            color: "#2e7d32",       // L√≠mite en Verde Bosque
                            weight: 4,              // Grosor t√©cnico
                            opacity: 1,
                            fillOpacity: 0          // SIN FONDO (Transparente)
                        };
                    },
                    onEachFeature: function(feature, layer) {
                        layer.bindPopup("<b>UMF Paxb√°n</b><br>Zona de Relieve");
                    }
                }).addTo(map);

                console.log("‚úÖ Capa Paxb√°n cargada.");
            })
            .catch(error => console.error("Error cargando el GeoJSON:", error));

        // Funci√≥n para filtrar y mostrar puntos
        window.filtrarPuntos = function(horas) {
            if (activeLine) {
                map.removeLayer(activeLine);
                activeLine = null;
            }
            incendiosLayer.clearLayers();
            
            allIncendios.forEach(p => {
                if (p.horas <= horas) {
                    const marker = L.circleMarker([p.lat, p.lon], {
                        radius: 8,
                        fillColor: p.color,
                        color: "#fff",
                        weight: 1,
                        opacity: 1,
                        fillOpacity: 0.8
                    });

                    let popupContent = `
                        <div style="font-family: sans-serif; min-width: 150px;">
                            <h6 style="margin:0; color:${p.color === 'red' ? 'red' : 'orange'};">üî• Foco Detectado</h6>
                            <hr style="margin:5px 0;">
                            <b>Sat√©lite:</b> ${p.sat}<br>
                            <b>Fecha:</b> ${p.fecha}<br>
                            <b>Ubicaci√≥n:</b> ${p.concesion}<br>
                            ${p.dist_info ? `<b>Distancia:</b> ${p.dist_info}<br>` : ''}
                            ${p.dist_campamento !== 'N/A' ? `<b>Ref:</b> ${p.dist_campamento}` : ''}
                        </div>
                    `;
                    marker.bindPopup(popupContent);

                    // Manejar clic en el marcador
                    marker.on('click', function(e) {
                        // Evitar que el clic llegue al mapa base (previene zooms accidentales)
                        L.DomEvent.stopPropagation(e);

                        if (typeof turf === 'undefined') {
                            console.error("‚ùå Turf.js no se ha cargado. La l√≠nea de distancia no funcionar√°.");
                            return;
                        }

                        let esMismoPunto = false;

                        // 1. Limpiar l√≠nea anterior y verificar si es el mismo punto (Toggle)
                        if (activeLine) {
                            const currentCoords = activeLine.getLatLngs();
                            esMismoPunto = (currentCoords[0].lat === p.lat && currentCoords[0].lng === p.lon);
                            
                            map.removeLayer(activeLine);
                            activeLine = null;
                        }

                        if (esMismoPunto) {
                            map.closePopup();
                            return; // Salimos (Toggle Off)
                        }

                        // 2. Trazar nueva l√≠nea negra si el pol√≠gono de Paxb√°n est√° cargado
                        if (paxbanFeature) {
                            try {
                                const from = turf.point([p.lon, p.lat]);
                                const line = turf.polygonToLine(paxbanFeature);
                                const snapped = turf.nearestPointOnLine(line, from);
                                
                                if (snapped && snapped.geometry) {
                                    // Priorizar la distancia oficial calculada en Python (GTM) para que coincida con el popup
                                    let distLabel = "";
                                    if (p.dist_info) {
                                        const match = p.dist_info.match(/(\d+)/);
                                        if (match) {
                                            distLabel = parseInt(match[0]).toLocaleString('en-US') + " m";
                                        }
                                    }
                                    
                                    if (!distLabel) {
                                        const distRaw = turf.distance(from, snapped, {units: 'kilometers'}) * 1000;
                                        distLabel = Math.round(distRaw).toLocaleString('en-US') + " m";
                                    }
                                    
                                    activeLine = L.polyline([
                                        [p.lat, p.lon],
                                        [snapped.geometry.coordinates[1], snapped.geometry.coordinates[0]]
                                    ], {
                                        color: '#000000', // L√≠nea Negra
                                        weight: 2,
                                        dashArray: '5, 5',
                                        opacity: 0.9
                                    });

                                    // A√±adir etiqueta de distancia en el centro de la l√≠nea
                                    activeLine.bindTooltip(distLabel, {
                                        permanent: true,
                                        direction: 'center',
                                        className: 'dist-label'
                                    });

                                    activeLine.addTo(map);
                                }
                            } catch (err) {
                                console.error("Error al calcular distancia visual:", err);
                            }
                        }

                        // 3. Centrar mapa y abrir informaci√≥n
                        map.panTo([p.lat, p.lon]);
                        marker.openPopup();
                    });
                    
                    incendiosLayer.addLayer(marker);
                }
            });
        };

        // Cargar Puntos de Incendio
        fetch('incendios.json?t=' + new Date().getTime())
            .then(response => response.json())
            .then(puntos => {
                console.log("üî• Puntos de calor cargados:", puntos.length);
                allIncendios = puntos;
                filtrarPuntos(72); // Mostrar todos por defecto (72h)
            });

        // Leyenda de colores
        const legend = L.control({position: 'bottomright'});
        legend.onAdd = function (map) {
            const div = L.DomUtil.create('div', 'legend');
            div.innerHTML += '<b>Antig√ºedad</b><br>';
            div.innerHTML += '<i style="background: red"></i> < 24h<br>';
            div.innerHTML += '<i style="background: orange"></i> 24h - 48h<br>';
            div.innerHTML += '<i style="background: yellow"></i> 48h - 72h<br>';
            return div;
        };
        legend.addTo(map);

        // Control de Filtros
        var filterControl = L.control({position: 'topright'});
        filterControl.onAdd = function (map) {
            var div = L.DomUtil.create('div', 'filter-control');
            div.innerHTML = '<b>Filtrar por Antig√ºedad</b><br>' +
                '<label><input type="radio" name="filtro_horas" value="24" onclick="filtrarPuntos(24)"> < 24h (Rojo)</label><br>' +
                '<label><input type="radio" name="filtro_horas" value="48" onclick="filtrarPuntos(48)"> < 48h (Naranja)</label><br>' +
                '<label><input type="radio" name="filtro_horas" value="72" onclick="filtrarPuntos(72)" checked> < 72h (Amarillo)</label>';
            L.DomEvent.disableClickPropagation(div);
            return div;
        };
        filterControl.addTo(map);

        // Cargar hora de √∫ltima actualizaci√≥n
        fetch('metadata.json?t=' + new Date().getTime())
            .then(response => response.json())
            .then(data => {
                document.getElementById('last-updated-label').innerText = "√öltima actualizaci√≥n: " + data.last_updated;
            })
            .catch(err => console.log("Esperando datos de actualizaci√≥n..."));
    </script>
</body>
</html>
