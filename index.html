<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Monitor de Incendios - Concesiones Forestales</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; font-family: 'Arial', sans-serif; }
        #map { height: 100vh; width: 100%; }
        .panel-control {
            position: absolute; top: 20px; left: 50px; z-index: 1000;
            background: rgba(0,0,0,0.85); color: white; padding: 15px;
            border-radius: 8px; width: 260px; border: 1px solid #555;
        }
        h3 { margin: 0 0 10px 0; font-size: 16px; color: #ffcc00; text-align: center; }
        .seccion { border-top: 1px solid #444; padding: 10px 0; margin-top: 5px; }
        label { display: block; font-size: 13px; margin: 5px 0; cursor: pointer; }
        .alerta-banner {
            position: absolute; top: 0; width: 100%; background: #e60000;
            color: white; text-align: center; padding: 10px; font-weight: bold;
            z-index: 2000; display: none; box-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }
    </style>
</head>
<body>

<div id="alertaBanner" class="alerta-banner">‚ö†Ô∏è ¬°INCENDIO DETECTADO EN: <span id="nombreZona"></span>! ‚ö†Ô∏è</div>

<div class="panel-control">
    <h3>MONITOR DE CONCESIONES</h3>
    
    <div class="seccion">
        <strong>Rango de Tiempo:</strong>
        <select id="filtroHoras" onchange="cargarDatos()" style="width:100%; margin-top:5px;">
            <option value="1">√öltimas 24 Horas</option>
            <option value="2" selected>√öltimas 48 Horas</option>
            <option value="3">√öltimos 3 D√≠as</option>
        </select>
    </div>

    <div class="seccion">
        <strong>Sat√©lites:</strong>
        <label><input type="checkbox" id="sat_modis" checked onchange="cargarDatos()"> MODIS</label>
        <label><input type="checkbox" id="sat_snpp" checked onchange="cargarDatos()"> VIIRS (SNPP)</label>
        <label><input type="checkbox" id="sat_noaa" checked onchange="cargarDatos()"> VIIRS (NOAA-20)</label>
    </div>

    <div class="seccion">
        <strong>Visualizaci√≥n:</strong>
        <label><input type="checkbox" id="verRegionales" checked onchange="cargarDatos()"> Ver puntos externos</label>
        <label><input type="checkbox" id="vistaSatelite" onchange="toggleMapa()"> Mapa Satelital</label>
    </div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    var map = L.map('map').setView([17.5, -90.0], 8);
    
    var capaBase = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    var capaSatelite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}');
    
    var marcadores = L.layerGroup().addTo(map);
    var capaPoligonos = L.layerGroup().addTo(map);

    // 1. Cargar y dibujar los pol√≠gonos desde el GeoJSON para que se vean todas las concesiones
    fetch('concesiones1.geojson')
        .then(res => res.json())
        .then(geojsonData => {
            L.geoJSON(geojsonData, {
                style: { color: 'yellow', weight: 1, fillOpacity: 0.05 },
                onEachFeature: function(feature, layer) {
                    layer.bindTooltip(feature.properties.Name); // Muestra nombre al pasar el mouse
                }
            }).addTo(capaPoligonos);
        });

    function toggleMapa() {
        if(document.getElementById('vistaSatelite').checked) {
            map.removeLayer(capaBase); capaSatelite.addTo(map);
        } else {
            map.removeLayer(capaSatelite); capaBase.addTo(map);
        }
    }

    function cargarDatos() {
        marcadores.clearLayers();
        document.getElementById('alertaBanner').style.display = 'none';
        
        const limiteDias = parseInt(document.getElementById('filtroHoras').value);
        const hoy = new Date();

        fetch('incendios.json?v=' + Date.now())
            .then(res => res.json())
            .then(data => {
                let zonasAfectadas = [];

                data.forEach(p => {
                    // Filtros de Sat√©lite
                    if (p.sat.includes("MODIS") && !document.getElementById('sat_modis').checked) return;
                    if (p.sat.includes("SNPP") && !document.getElementById('sat_snpp').checked) return;
                    if (p.sat.includes("NOAA20") && !document.getElementById('sat_noaa').checked) return;

                    // Filtro de Tiempo
                    const fechaP = new Date(p.fecha);
                    const diasDiff = (hoy - fechaP) / (1000 * 60 * 60 * 24);
                    if (diasDiff > limiteDias) return;

                    // Filtro de Externos
                    if (!document.getElementById('verRegionales').checked && !p.alerta) return;

                    // Color: Rojo fuerte para incendios en concesi√≥n, Naranja para externos
                    const colorPunto = p.alerta ? "#ff0000" : "#ff8c00";
                    
                    L.circleMarker([p.lat, p.lon], {
                        radius: p.alerta ? 10 : 6,
                        fillColor: colorPunto, color: "white", weight: 1, fillOpacity: 0.8
                    }).addTo(marcadores).bindPopup(`
                        <b>${p.alerta ? 'üî• INCENDIO: ' + p.concesion : 'Punto Regional'}</b><br>
                        Sat√©lite: ${p.sat}<br>
                        Fecha: ${p.fecha}<br>
                        Coord: ${p.lat}, ${p.lon}
                    `);

                    if(p.alerta) {
                        if(!zonasAfectadas.includes(p.concesion)) zonasAfectadas.push(p.concesion);
                    }
                });

                // Mostrar banner si hay alertas
                if(zonasAfectadas.length > 0) {
                    document.getElementById('alertaBanner').style.display = 'block';
                    document.getElementById('nombreZona').innerText = zonasAfectadas.join(", ");
                }
            });
    }

    // Recargar datos cada 5 minutos autom√°ticamente
    setInterval(cargarDatos, 300000);
    cargarDatos();
</script>
</body>
</html>
