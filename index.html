<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor de Incendios Paxb√°n</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        body { margin: 0; padding: 0; font-family: sans-serif; }
        #map { height: 100vh; width: 100%; }
        
        .controls {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            min-width: 200px;
        }
        
        .filter-group { margin-bottom: 10px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        select { padding: 5px; width: 100%; }
        
        .legend {
            margin-top: 15px;
            font-size: 12px;
        }
        .legend-item { display: flex; align-items: center; margin-bottom: 4px; }
        .dot { width: 12px; height: 12px; border-radius: 50%; margin-right: 8px; display: inline-block; }
    </style>
</head>
<body>

    <div class="controls">
        <h3>Filtros</h3>
        <div class="filter-group">
            <label for="timeFilter">Rango de Tiempo:</label>
            <select id="timeFilter" onchange="actualizarMapa()">
                <option value="24" selected>√öltimas 24 horas (Rojo)</option>
                <option value="48">√öltimas 48 horas (Naranja)</option>
                <option value="72">√öltimas 72 horas (Amarillo)</option>
            </select>
        </div>

        <div class="filter-group">
            <label>Sat√©lites:</label>
            <div style="text-align: left;">
                <input type="checkbox" id="satModis" value="MODIS_NRT" checked onchange="actualizarMapa()">
                <label for="satModis" style="display:inline; font-weight:normal;">MODIS</label><br>
                <input type="checkbox" id="satViirsSnpp" value="VIIRS_SNPP_NRT" checked onchange="actualizarMapa()">
                <label for="satViirsSnpp" style="display:inline; font-weight:normal;">VIIRS SNPP</label><br>
                <input type="checkbox" id="satViirsNoaa" value="VIIRS_NOAA20_NRT" checked onchange="actualizarMapa()">
                <label for="satViirsNoaa" style="display:inline; font-weight:normal;">VIIRS NOAA20</label>
            </div>
        </div>
        
        <div class="legend">
            <div class="legend-item"><span class="dot" style="background: red;"></span> ‚â§ 24 Horas</div>
            <div class="legend-item"><span class="dot" style="background: orange;"></span> ‚â§ 48 Horas</div>
            <div class="legend-item"><span class="dot" style="background: yellow;"></span> ‚â§ 72 Horas</div>
        </div>
        <div style="margin-top:10px; font-size:11px; color:#666;">
            Datos actualizados cada hora.
            <div id="info-actualizacion" style="margin-top: 8px; font-size: 13px; color: #333; border-top: 1px solid #ccc; padding-top: 5px;">Verificando fecha...</div>
            <div style="margin-top: 5px; font-style: italic;">Desarrollado por JR23CR</div>
        </div>
    </div>

    <div id="map"></div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        // Inicializar mapa centrado en Pet√©n, Guatemala
        var map = L.map('map').setView([17.5, -90.0], 9);

        // Capas Base
        var osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        });

        var natGeo = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/NatGeo_World_Map/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri &mdash; National Geographic, Esri, DeLorme, NAVTEQ, UNEP-WCMC, USGS, NASA, ESA, METI, NRCAN, GEBCO, NOAA, iPC',
            maxZoom: 16
        }).addTo(map);

        var satelital = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
        });

        var incendiosLayer = L.layerGroup().addTo(map);
        var concesionesLayer = L.layerGroup().addTo(map);

        // Control de Capas (Posicionado a la izquierda para no tapar el panel de filtros)
        L.control.layers({
            "National Geographic": natGeo,
            "Sat√©lite": satelital,
            "OpenStreetMap": osm
        }, {
            "Incendios": incendiosLayer,
            "Concesiones": concesionesLayer
        }, { position: 'topleft' }).addTo(map);

        var datosIncendios = [];

        // Cargar Concesiones (GeoJSON)
        fetch('concesiones1.geojson')
            .then(response => response.json())
            .then(data => {
                L.geoJSON(data, {
                    style: function(feature) {
                        return { color: "#2e7d32", weight: 2, fillOpacity: 0.1 };
                    },
                    onEachFeature: function(feature, layer) {
                        if (feature.properties && feature.properties.Name) {
                            layer.bindPopup("<b>Concesi√≥n:</b> " + feature.properties.Name);
                        }
                    }
                }).addTo(concesionesLayer);
            })
            .catch(err => console.error("Error cargando concesiones:", err));

        // Cargar Incendios
        fetch('incendios.json')
            .then(response => {
                var lastMod = response.headers.get('Last-Modified');
                if (lastMod) {
                    var date = new Date(lastMod);
                    document.getElementById('info-actualizacion').innerText = "√öltima actualizaci√≥n: " + date.toLocaleString('es-GT');
                } else {
                    document.getElementById('info-actualizacion').innerText = "√öltima actualizaci√≥n: Reciente";
                }
                return response.json();
            })
            .then(data => {
                datosIncendios = data;
                
                // Auto-centrar el mapa si hay datos
                if (datosIncendios.length > 0) {
                    var bounds = L.latLngBounds(datosIncendios.map(p => [p.lat, p.lon]));
                    map.fitBounds(bounds, { padding: [50, 50], maxZoom: 12 });
                }

                actualizarMapa(); // Aplicar filtro inicial (24h)
            })
            .catch(err => {
                console.error("Error cargando incendios:", err);
                document.getElementById('info-actualizacion').innerHTML = "<span style='color:red'>Error cargando datos.</span>";
            });

        function actualizarMapa() {
            incendiosLayer.clearLayers();
            
            var horasFiltro = parseInt(document.getElementById('timeFilter').value);
            
            var mostrarModis = document.getElementById('satModis').checked;
            var mostrarViirsSnpp = document.getElementById('satViirsSnpp').checked;
            var mostrarViirsNoaa = document.getElementById('satViirsNoaa').checked;
            
            var visibles = 0;

            datosIncendios.forEach(punto => {
                // Filtrar por tiempo y por sat√©lite seleccionado
                var satValido = (punto.sat === "MODIS_NRT" && mostrarModis) || (punto.sat === "VIIRS_SNPP_NRT" && mostrarViirsSnpp) || (punto.sat === "VIIRS_NOAA20_NRT" && mostrarViirsNoaa);

                if (punto.horas <= horasFiltro && satValido) {
                    visibles++;
                    
                    var color = punto.color;
                    
                    var circle = L.circleMarker([punto.lat, punto.lon], {
                        radius: 6,
                        fillColor: color,
                        color: "#000",
                        weight: 1,
                        opacity: 1,
                        fillOpacity: 0.8
                    });

                    var popupContent = `
                        <b>üî• Punto de Calor Detectado</b><br>
                        <b>GTM:</b> ${punto.gtm}<br>
                        <b>Lat/Lon:</b> ${punto.lat.toFixed(4)}, ${punto.lon.toFixed(4)}<br>
                        <b>Fecha:</b> ${punto.fecha}<br>
                        <b>Antig√ºedad:</b> ${punto.horas.toFixed(1)} horas<br>
                        <b>Ubicaci√≥n:</b> ${punto.concesion}<br>
                        <b>Sat√©lite:</b> ${punto.sat}
                    `;

                    circle.bindPopup(popupContent);
                    incendiosLayer.addLayer(circle);
                }
            });
        }
    </script>
</body>
</html>